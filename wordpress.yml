---
- hosts: vm2
  become: yes
  gather_facts: false
  
  pre_tasks:
    
    - name: Install python2 for Ansible
      raw: bash -c "test -e /usr/bin/python || (apt -qqy update && apt install -qqy python-minimal)"
      register: output
      changed_when: output.stdout != ""
      
    - name: Gathering Facts
      setup:
  
    - name: "Load role variables"
      include_vars: "./vars/{{ item }}.yml"
      with_items:
        - "append-hostname"
        - "apache"
        - "openssl"
    
    - name: "Load OS specific variables for mysql role"
      include_vars: "{{ item }}"
      with_first_found:
        - files:
          - "./vars/{{ ansible_distribution }}-{{ ansible_distribution_version }}_mysql.yml"
          - "./vars/{{ ansible_distribution }}-{{ ansible_distribution_release }}_mysql.yml"
          - "./vars/{{ ansible_distribution }}-{{ ansible_distribution_major_version }}_mysql.yml"
          - "./vars/{{ ansible_distribution }}_mysql.yml"
          - "./vars/{{ ansible_os_family }}_mysql.yml"
          - "./vars/mysql.yml"
    - debug:
        msg: "mysql_packages={{mysql_packages}}"
    
    - name: "Load role variables for wordpress play"
      include_vars: "./vars/wordpress/{{ item }}.yml"
      with_items:
        - "mysql"
    
    - name: "Get mysql password from password-file"
      include_role: 
        name: password-file
      vars:
        path: /root
        pass_id: mysql_root
        pass_len: 32
    
    - set_fact:
        mysql_root_password: "{{ passwords.mysql_root }}"
    
    - name: "Get mysql password from password-file"
      include_role: 
        name: password-file
      vars:
        path: /root
        pass_id: mysql_wordpress
        pass_len: 32
    
    #add mysql password to mysql_users[0] dictionary
    - set_fact:
        tmp: '{"password":"{{ passwords.mysql_wordpress }}" }'
    - set_fact:
        mysql_users: "[ {{ mysql_users[0]|combine( tmp ) }} ]"
    - debug:
        msg: "mysql_users={{ mysql_users }}"
      
    - name: "Load OS specific variables for php role as needed for wordpress play"
      include_vars: "{{ item }}"
      with_first_found:
        - files:
          - "./vars/wordpress/{{ ansible_distribution }}-{{ ansible_distribution_version }}_php.yml"
          - "./vars/wordpress/{{ ansible_distribution }}-{{ ansible_distribution_release }}_php.yml"
          - "./vars/wordpress/{{ ansible_distribution }}-{{ ansible_distribution_major_version }}_php.yml"
          - "./vars/wordpress/{{ ansible_distribution }}_php.yml"
          - "./vars/wordpress/{{ ansible_os_family }}_php.yml"
  roles:
    - append-hostname
    - geerlingguy.apache
    - franklinkim.openssl
    - geerlingguy.php
    - geerlingguy.mysql
#  - geerlingguy.php-mysql
#  - geerlingguy.apache-php-fpm
